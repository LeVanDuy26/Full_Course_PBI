Mặc dù Power Query Editor cho phép bạn gộp bảng (Merging queries), nhưng Power BI, sẽ tốt hơn nếu **chia dữ liệu ra thành các bảng nhỏ hơn và tạo relationships cho chúng**.

*   **Lợi ích của Chuẩn hóa (Normalization):** Chuẩn hóa Database (tổ chức dữ liệu tại các cột - bảng trong một mối quan hệ) giúp loại bỏ dữ liệu dư thừa, giảm kích thước bảng, cải thiện tốc độ xử lý, giảm thiểu lỗi, và đơn giản hóa cấu trúc cơ sở dữ liệu cho mục đích phân tích.
*   **Nguyên tắc Mô hình hóa:** Bảng dài và hẹp (nhiều dòng, ít cột) luôn được coi là tốt hơn bảng ngắn và rộng. Cần đảm bảo mỗi bảng là một bảng riêng biệt, cho một mục đích cụ thể.

---

## II. Khái Niệm Cơ Bản về Mô hình Dữ liệu (Data Model)

### A. Định nghĩa Mô hình Dữ liệu

1.  **Nhóm Bảng Độc lập:** Một nhóm bảng chưa có các mối quan hệ được xác định chưa phải là một mô hình dữ liệu, và việc khai thác sẽ dẫn đến hiện tượng dữ liệu tổng hợp độc lập.
2.  **Mô hình Dữ liệu Hoàn chỉnh:** Là một mô hình đã có các mối quan hệ (relationship) được kết nối thông qua trường dữ liệu chung (key field). Khi khai thác, mô hình này sẽ tổng hợp được dữ liệu từ các bảng độc lập.

### B. Phân loại Bảng trong Data Model

Một mô hình dữ liệu tiêu chuẩn thường có hai loại bảng chính:

| Loại Bảng | Tên gọi khác | Đặc điểm dữ liệu | Vai trò |
| :--- | :--- | :--- | :--- |
| **Fact Tables** | Data tables | Chứa các giá trị số hoặc chỉ số được dùng để tính toán/tổng hợp (ví dụ: sales, transactions, quantity). Thường ở cấp độ chi tiết (đầu tiên). | Chứa dữ liệu giao dịch hoặc dữ liệu định lượng. |
| **Dimension Tables** | Lookup tables | Chứa dữ liệu mang tính diễn giải, liên quan đến nhóm, phân loại (ví dụ: products, customers, dates, stores). Thường là dữ liệu dạng text. | Cung cấp ngữ cảnh và thông tin bổ sung cho các Fact. |

### C. Khái niệm Primary Keys và Foreign Keys

Việc kết nối các bảng được thực hiện thông qua trường dữ liệu chung (key field). Các tài liệu phân biệt rõ hai loại khóa (key) chính:

1.  **Khóa Chính (Primary Keys - PK):**
    *   Tính chất: Là trường làm key có tính chất **duy nhất** (không lặp lại) các giá trị trong cột.
    *   Vị trí: Thường tồn tại ở bảng **dimension** (lookup).
2.  **Khóa Phụ (Foreign Keys - FK):**
    *   Tính chất: Là trường làm key có tính chất **lặp lại** các giá trị nhiều lần trong cột.
    *   Vị trí: Thường tồn tại ở bảng **fact** và kết nối tới Primary Keys ở bảng dimension.

---

## III. Quy Trình Tạo và Quản lý Relationships

### A. Cách Tạo Relationships

Trong màn hình Model View, bạn có thể tạo mối quan hệ giữa các bảng bằng hai cách chính:

1.  **Kéo và Thả (Drag and Drop):** Kéo và thả kết nối trực tiếp giữa trường khóa chính và khóa phụ giữa 2 bảng trên Model View.
2.  **Hộp thoại Manage Relationships:** Sử dụng nút lệnh `Manage relationships` trên Ribbon để gọi hộp thoại chức năng, từ đó thêm hoặc sử dụng chức năng phát hiện relationships.

### B. Các Kiểu Cardinality (Tính duy nhất)

Cardinality là khái niệm dùng để đọc/hiểu mức độ duy nhất hoặc lặp lại của giá trị trong trường làm key giữa các bảng.

*   **Many:** Các giá trị trong trường làm key có tính chất lặp lại (thường là FK).
*   **One:** Các giá trị trong trường làm key có tính chất duy nhất (thường là PK).

Trong relationship tiêu chuẩn của Power BI, chuyên gia luôn khuyến nghị sử dụng:

*   **Many-to-one:** Kết nối dữ liệu giữa bảng fact và dimension.
*   **One-to-one:** Kết nối dữ liệu giữa các bảng dimension.
*   **Lưu ý:** Tuyệt đối **không nên dùng** quan hệ Many-to-many.

### C. Quản lý Hướng Bộ Lọc (Cross Filter Direction)

Filter direction (hướng bộ lọc) liên quan đến chiều lọc và tính toán dữ liệu khi sử dụng trường làm key trong visual.

*   **Single (Mặc định):** Chỉ cho phép 1 hướng lọc để tính toán. Khi sử dụng dữ liệu từ nhiều bảng fact, bạn cần sử dụng trường làm key ở bảng dimension trong visual.
*   **Both (Hai chiều):** Cho phép tham chiếu 2 chiều.
    *   **Khuyến nghị:** Cần rất hạn chế sử dụng dạng Both vì dễ gây ra sự mơ hồ về mô hình dữ liệu, có thể làm một số dữ liệu inactive, và có thể gây hiện tượng thiếu dữ liệu chi tiết.

### D. Active và Inactive Relationships

Giữa 2 bảng có thể có nhiều hơn một mối quan hệ, nhưng chỉ **một** relationship được phép hoạt động (active) để định nghĩa tham chiếu dữ liệu mặc định.

*   **Active Relationship:** Hiển thị nét liền và đang hoạt động.
*   **Inactive Relationship:** Hiển thị nét đứt và không hoạt động.

Bạn có thể tùy biến active/inactive relationship bằng hộp thoại Edit Relationship.

### E. Các Mô hình Dữ liệu Phổ biến

1.  **Mô hình STAR:** Là mô hình phổ biến nhất. Đặc điểm là có 1 bảng fact table kết nối trực tiếp tới nhiều bảng dimension (lookup tables được kết nối xung quanh một data tables trung tâm).
2.  **Mô hình SNOWFLAKE:** Là mô hình mở rộng của STAR. Ngoài kết nối fact-dimension, còn có mối quan hệ giữa các bảng dimension, tạo thành chuỗi kết nối bắc cầu.

### F. Lưu ý khi Kết nối Nhiều Bảng Fact

Khi mô hình dữ liệu có 2 bảng fact (ví dụ: Sales và Returns):

*   **Cấm kỵ:** Không kết nối trực tiếp 2 bảng fact này vì sẽ tạo ra mối quan hệ many-to-many, khiến Power BI không tham chiếu được đúng dữ liệu.
*   **Giải pháp:** Kết nối từng bảng fact (Sales, Returns) tới các bảng dimension tương ứng của nó. Lúc này sẽ có các bảng dimension chung (ví dụ: Product), chính các bảng này sẽ mang tính chất tham chiếu gián tiếp thông tin giữa các bảng fact.

---

## IV. Tận Dụng Data Model trong Phân Tích (DAX)

Data Analysis Expressions (DAX) là tập hợp các hàm, toán tử và hằng số được sử dụng để tính toán giá trị. DAX rất mạnh mẽ và linh hoạt vì được xây dựng chuyên biệt để làm việc với các data model. DAX yêu cầu phải tạo ra các mối quan hệ giữa các bảng để có thể sử dụng được.

### A. Ngữ Cảnh (Context) và DAX

DAX hoạt động dựa trên Ngữ cảnh (Context):

1.  **Row Context (Ngữ cảnh Hàng):** Áp dụng bất cứ khi nào một công thức có hàm áp dụng bộ lọc để xác định một hàng trong bảng.
    *   Calculated Column sử dụng ngữ cảnh hàng, tham chiếu từng giá trị trong cột để tính toán và tạo cột mới.
2.  **Filter Context (Ngữ cảnh Lọc):** Giống như một hoặc nhiều bộ lọc được áp dụng trong phép tính.
    *   Measures hoạt động theo Filter Context trong visual, nghĩa là chúng sẽ tự động cập nhật khi các bộ lọc thay đổi mà không cần viết lại công thức.

### B. Hàm RELATED()

Hàm `RELATED()` là một công cụ DAX quan trọng tận dụng mối quan hệ (relationship) trong Data Model.

1.  **Mục đích:** Trả về các giá trị trong mỗi hàng của bảng dựa trên mối quan hệ với các bảng khác.
2.  **Hoạt động:** `RELATED()` hoạt động giống như hàm `VLOOKUP` trong Excel, sử dụng mối quan hệ giữa các bảng để tham chiếu giá trị từ bảng dimension vào một cột mới của bảng fact.
3.  **Ngữ cảnh sử dụng:** `RELATED` sử dụng Row Context, do đó nó thường chỉ được dùng khi tạo **Calculated Column** hoặc là một phần của các hàm lặp (như `FILTER`, `SUMX`, `MAXX`) bên trong một Measure.

**Ví Dụ Code:**

Để tạo một Calculated Column trong bảng giao dịch (`Transactions`) để lấy tên sản phẩm từ bảng tra cứu sản phẩm (`Product Lookup`) thông qua mối quan hệ đã thiết lập:

| DAX NAME | Tên HÀM | Cú pháp | Giải thích |
| :--- | :--- | :--- | :--- |
| `Product Name` | `RELATED` | `= RELATED('Product Lookup'[Product Name])` | Hàm này đi tới bảng `Product Lookup` qua mối quan hệ Many-to-one và trả về tên sản phẩm cho từng hàng trong bảng `Transactions`. |

### C. Các Hàm DAX Đặc thù cho Relationships

Ngoài `RELATED`, nhóm hàm Relationship trong DAX còn bao gồm các hàm đặc thù khác giúp thao tác với mô hình dữ liệu:

*   **`RELATEDTABLE`:** Thường được sử dụng để trả về một bảng các giá trị từ bảng liên quan.
*   **`CROSSFILTER`:** Cho phép thay đổi hướng bộ lọc hoặc vô hiệu hóa bộ lọc cho một relationship cụ thể trong ngữ cảnh của một công thức DAX.
*   **`USERELATIONSHIP`:** Tạm thời kích hoạt một relationship không hoạt động (inactive relationship) cho mục đích tính toán trong công thức DAX, giải quyết vấn đề khi có nhiều hơn một mối quan hệ giữa hai bảng.